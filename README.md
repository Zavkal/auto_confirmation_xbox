# Auto Confirmation Service

Сервис автоматического подтверждения с поддержкой RabbitMQ и устойчивостью к сбоям соединения.

## Особенности

- **Автоматическое переподключение**: При сбоях соединения с RabbitMQ сервис автоматически переподключается
- **Обработка ошибок**: Корректная обработка `StreamLostError`, `ConnectionResetError` и других ошибок соединения
- **Надежная доставка**: Сообщения сохраняются на диск для предотвращения потери данных
- **Heartbeat**: Поддержка heartbeat для мониторинга состояния соединения
- **Автоматический перезапуск**: Docker Compose автоматически перезапускает контейнер при сбоях и рестарте системы

## Установка

1. Установите зависимости:
```bash
pip install -r requirements.txt
```

2. Создайте файл `.env` с настройками RabbitMQ:
```env
RABBITMQ_USER=your_username
RABBITMQ_PASS=your_password
RABBITMQ_HOST=your_host
RABBITMQ_QUEUE_REQUEST=request_queue
RABBITMQ_QUEUE_RESPONSE=response_queue
```

## Запуск

### Основной сервис
```bash
python main.py
```

### Тестирование устойчивости соединения
```bash
python test_connection.py
```

## Docker

### Быстрый старт с Makefile
```bash
# Показать все доступные команды
make help

# Собрать и запустить контейнер
make start

# Посмотреть логи
make logs

# Остановить контейнер
make down

# Перезапустить контейнер
make restart

# Проверить статус
make status
```


### Автоматический запуск при рестарте системы

Docker Compose автоматически перезапускает контейнер при сбоях и при рестарте системы благодаря настройке `restart: unless-stopped` в `docker-compose.yml`.

**Для автозапуска при рестарте системы:**
```bash
# Запустить контейнер
make start

# Docker автоматически перезапустит контейнер при:
# - Сбоях приложения
# - Рестарте системы
# - Перезагрузке Docker
```

### Дополнительные команды Makefile
```bash
# Тестирование соединения
make test

# Мониторинг логов в реальном времени
make monitor

# Резервное копирование логов
make backup-logs

# Очистка (удаление контейнера и образов)
make clean
```

### Ручное управление docker-compose
```bash
# Сборка и запуск
docker-compose up -d --build

# Остановка
docker-compose down

# Просмотр логов
docker-compose logs -f

# Перезапуск
docker-compose restart
```

## Мониторинг

Сервис выводит подробные логи о состоянии соединения:
- Подключение к RabbitMQ
- Ошибки соединения
- Попытки переподключения
- Обработка сообщений

## Устранение проблем

### Ошибка "Connection reset by peer"
Эта ошибка теперь обрабатывается автоматически. Сервис:
1. Логирует ошибку
2. Закрывает текущее соединение
3. Ждет 5 секунд
4. Переподключается к RabbitMQ

### Ошибка "Stream connection lost"
Аналогично обрабатывается автоматически с переподключением.

### Проверка состояния
Используйте `test_connection.py` для проверки устойчивости соединения:
```bash
python test_connection.py
```

## Конфигурация

Основные параметры соединения в `config.py`:
- `heartbeat=600` - Heartbeat каждые 10 минут
- `blocked_connection_timeout=300` - Таймаут блокировки 5 минут
- `connection_attempts=3` - 3 попытки подключения
- `retry_delay=2` - Задержка между попытками 2 секунды
- `socket_timeout=10` - Таймаут сокета 10 секунд

## Логирование

Все события логируются в формате:
```
2025-01-19 22:58:44,139 - module_name - LEVEL - message
```

Уровни логирования:
- `INFO` - Обычные операции
- `WARNING` - Предупреждения
- `ERROR` - Ошибки соединения
